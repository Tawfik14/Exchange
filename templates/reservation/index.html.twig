{% extends 'base.html.twig' %}
{% block title %}Réservation{% endblock %}

{% block body %}
<div style="max-width: 1100px; margin: 2rem auto;">
  <h1>Réserver des devises</h1>

  {% for m in app.flashes('success') %}
    <div style="background:#093;color:#fff;padding:.6rem 1rem;border-radius:10px;margin:.75rem 0;">{{ m }}</div>
  {% endfor %}
  {% for m in app.flashes('error') %}
    <div style="background:#900;color:#fff;padding:.6rem 1rem;border-radius:10px;margin:.75rem 0;">{{ m }}</div>
  {% endfor %}

  <form method="post" action="{{ path('app_reservation', {mode: mode}) }}" style="display:grid; gap: 12px;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
      <div>
        <label>Prénom</label>
        <input name="first_name" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);" />
      </div>
      <div>
        <label>Nom</label>
        <input name="last_name" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);" />
      </div>
    </div>

    <div>
      <label>Je souhaite</label>
      <select name="operation" style="padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);">
        <option value="buy">Acheter des devises (je paie en EUR)</option>
        <option value="sell">Vendre des devises (je reçois des EUR)</option>
      </select>
    </div>

    <div id="items" style="display:grid; gap: 10px;">
      <div class="item-row" style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; align-items:end;">
        <div>
          <label>Devise</label>
          <select name="item_currency[]" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);">
            <option value="">Choisir…</option>
            {% for c in currencies %}
              <option value="{{ c.code }}">{{ c.flag }} {{ c.country }} ({{ c.code }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Montant EUR</label>
          <input name="item_eur[]" type="number" step="0.01" min="0" placeholder="ex: 100.00" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);" />
        </div>
        <div>
          <label>Montant devise</label>
          <input name="item_local[]" type="number" step="0.01" min="0" placeholder="ex: 120.00" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04);color:var(--text);" />
        </div>
      </div>
    </div>

    <div>
      <button type="button" id="add-row" class="btn" style="margin-right:8px;">Ajouter une devise</button>
      <button class="btn btn-primary" type="submit">Réserver</button>
    </div>
  </form>

  <hr style="margin:2rem 0;border-color:var(--border);" />

  <h2>Mes réservations</h2>
  {% if myReservations is empty %}
    <p style="color:#93a1c6;">Aucune réservation.</p>
  {% else %}
    <table style="width:100%;border-collapse:collapse;border:1px solid var(--border);">
      <thead>
        <tr><th style="padding:10px;text-align:left;">Commande</th>
            <th style="padding:10px;text-align:left;">Date</th>
            <th style="padding:10px;text-align:left;">Échéance</th>
            <th style="padding:10px;text-align:left;">Statut</th>
            <th style="padding:10px;text-align:left;">Détail</th></tr>
      </thead>
      <tbody>
        {% for r in myReservations %}
          {% set now = date() %}
          {% set expired = (r.status == 'pending' and r.pickupDeadline < now) %}
          <tr style="border-top:1px solid var(--border);">
            <td style="padding:10px;font-weight:600;">{{ r.orderCode }}</td>
            <td style="padding:10px;">{{ r.createdAt|date('Y-m-d H:i') }}</td>
            <td style="padding:10px;">{{ r.pickupDeadline|date('Y-m-d H:i') }}</td>
            <td style="padding:10px;">
              {% if r.status == 'completed' %}
                <span style="color:#6ee7a3;">Transaction passée</span>
              {% elseif expired %}
                <span style="color:#ff9b9b;">Expirée</span>
              {% else %}
                {% set seconds = (r.pickupDeadline|date('U') - now|date('U')) %}
                {% set mins = (seconds / 60)|round(0, 'floor') %}
                <span style="color:#ffd166;">{{ mins }} min restantes</span>
              {% endif %}
            </td>
            <td style="padding:10px;">
              <a class="btn" href="{{ path('app_reservation_recap', {id: r.id, mode: mode}) }}">Voir</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const addBtn = document.getElementById('add-row');
  const items = document.getElementById('items');
  if (addBtn && items) {
    addBtn.addEventListener('click', () => {
      const row = document.querySelector('.item-row');
      const clone = row.cloneNode(true);
      // Clear values
      clone.querySelectorAll('input').forEach(i => i.value = '');
      clone.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
      items.appendChild(clone);
    });
  }
});
</script>
{% endblock %}
